# 認証システム仕様書

## 概要
EvoXシステムでは、管理者向けにSMS OTP（One-Time Password）認証を採用した2段階認証システムを実装しています。

## 認証フロー

### 1. ログイン手順
1. **電話番号・パスワード入力**
   - 管理者の電話番号とパスワードを入力
   - システムで認証情報を検証

2. **SMS OTP送信**
   - 認証情報が正しい場合、6桁のOTPコードをSMSで送信
   - 重複送信防止機能付き

3. **OTP認証**
   - 受信した6桁のOTPコードを入力
   - システムでOTPコードを検証

4. **セッション開始**
   - 認証成功後、管理者セッションを開始
   - ダッシュボードにリダイレクト

## 技術実装

### データベース設計

#### 管理者テーブル（user_admins）
```sql
CREATE TABLE user_admins (
    id BIGINT PRIMARY KEY,
    admin_name VARCHAR(255),
    admin_phone VARCHAR(20),
    admin_email VARCHAR(255),
    admin_password VARCHAR(255),
    admin_created_at TIMESTAMP,
    admin_updated_at TIMESTAMP
);
```

#### OTPコードテーブル（otp_codes_admin）
```sql
CREATE TABLE otp_codes_admin (
    id BIGINT PRIMARY KEY,
    adminopt_admin_id BIGINT,
    adminopt_code VARCHAR(6),
    adminopt_temp_id VARCHAR(13),
    adminopt_expires_at TIMESTAMP,
    adminopt_is_used BOOLEAN DEFAULT FALSE,
    adminopt_created_at TIMESTAMP
);
```

### コントローラー実装

#### AdminAuthController
```php
class AdminAuthController extends Controller
{
    // ログイン処理（OTP送信）
    public function login(Request $request)
    
    // OTP認証処理
    public function verifyOtp(Request $request)
    
    // ログアウト処理
    public function logout(Request $request)
}
```

### ミドルウェア

#### AdminMiddleware
```php
class AdminMiddleware
{
    public function handle(Request $request, Closure $next)
    {
        // セッション開始
        if (!$request->session()->isStarted()) {
            $request->session()->start();
        }

        // 認証チェック
        if (!Auth::guard('admin')->check()) {
            // APIリクエストの場合はJSONレスポンス
            if ($request->expectsJson()) {
                return response()->json(['message' => '認証が必要です。'], 401);
            }
            
            // Webリクエストの場合はログインページにリダイレクト
            return redirect('/admin-' . env('ADMIN_URL_HASH', 'evox2025'));
        }

        return $next($request);
    }
}
```

## セキュリティ機能

### 1. 重複送信防止
- **フロントエンド**: JavaScriptフラグによる重複クリック防止
- **バックエンド**: 既存OTPコードの存在チェック
- **データベース**: OTPコードの有効期限管理

### 2. セッション管理
- **セッション開始**: 明示的なセッション開始処理
- **セッション保存**: 認証後のセッション保存
- **セッション無効化**: ログアウト時のセッション破棄

### 3. CSRF保護
- **トークン生成**: Laravel標準CSRFトークン
- **トークン検証**: 全フォームでCSRFトークン検証
- **API保護**: セッションベース認証による保護

## フロントエンド実装

### ログイン画面（admin/login.blade.php）
```javascript
// 重複送信防止フラグ
let isSubmitting = false;

// ログイン処理
async function login() {
    if (isSubmitting) return;
    
    isSubmitting = true;
    try {
        const response = await fetch('/api/admin/auth/login', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
            },
            body: JSON.stringify({
                admin_phone: phoneNumber,
                admin_password: password,
                temp_id: tempId
            })
        });
        
        // レスポンス処理
        const data = await response.json();
        if (response.ok) {
            // OTP入力画面に遷移
            showOtpSection();
        } else {
            showError(data.message);
        }
    } finally {
        isSubmitting = false;
    }
}

// OTP認証処理
async function verifyOtp() {
    if (isSubmitting) return;
    
    isSubmitting = true;
    try {
        const response = await fetch('/api/admin/auth/verify-otp', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
            },
            body: JSON.stringify({
                temp_id: tempId,
                otp_code: otpCode
            })
        });
        
        const data = await response.json();
        if (response.ok) {
            // ダッシュボードにリダイレクト
            window.location.href = data.data.redirect_url;
        } else {
            showOtpError(data.message);
        }
    } finally {
        isSubmitting = false;
    }
}
```

## 設定項目

### 環境変数
```env
# 管理者認証設定
ADMIN_URL_HASH=evox2025

# SMS設定
SMS_SERVICE=twilio
TWILIO_ACCOUNT_SID=your_account_sid
TWILIO_AUTH_TOKEN=your_auth_token
TWILIO_PHONE_NUMBER=your_phone_number
```

### 認証設定（config/auth.php）
```php
'guards' => [
    'admin' => [
        'driver' => 'session',
        'provider' => 'admins',
    ],
],

'providers' => [
    'admins' => [
        'driver' => 'eloquent',
        'model' => App\Models\UserAdmin::class,
    ],
],
```

## エラーハンドリング

### 1. 認証エラー
- **電話番号・パスワード不一致**: 401 Unauthorized
- **OTPコード不一致**: 400 Bad Request
- **OTP有効期限切れ**: 400 Bad Request

### 2. セッションエラー
- **セッション切れ**: 401 Unauthorized
- **権限不足**: 403 Forbidden

### 3. システムエラー
- **SMS送信失敗**: 500 Internal Server Error
- **データベースエラー**: 500 Internal Server Error

## ログ機能

### 認証ログ
```php
// ログイン試行
\Log::info('Admin login attempt', [
    'phone' => $request->admin_phone,
    'ip' => $request->ip(),
    'user_agent' => $request->userAgent()
]);

// 認証成功
\Log::info('Admin authentication successful', [
    'admin_id' => $admin->id,
    'admin_name' => $admin->admin_name
]);

// 認証失敗
\Log::warning('Admin authentication failed', [
    'phone' => $request->admin_phone,
    'reason' => 'Invalid credentials'
]);
```

## テスト機能

### 自動テスト
```php
// 認証テスト
public function test_admin_login()
{
    $response = $this->post('/api/admin/auth/login', [
        'admin_phone' => '8090330374',
        'admin_password' => 'admin123',
        'temp_id' => 'test123'
    ]);
    
    $response->assertStatus(200);
    $response->assertJson(['message' => '認証コードを送信しました。']);
}
```

### cURLテスト
```bash
# ログイン試行
curl -X POST http://localhost:8000/api/admin/auth/login \
  -H "Content-Type: application/json" \
  -H "X-CSRF-TOKEN: your_csrf_token" \
  -d '{
    "admin_phone": "8090330374",
    "admin_password": "admin123",
    "temp_id": "test123"
  }'
```

## 運用・保守

### 1. 定期メンテナンス
- **OTPコードクリーンアップ**: 期限切れOTPコードの削除
- **セッション管理**: 古いセッションの削除
- **ログローテーション**: 認証ログの定期整理

### 2. セキュリティ監視
- **不正アクセス検知**: ログイン試行回数の監視
- **異常パターン検知**: 不正なアクセスパターンの検知
- **アラート機能**: セキュリティインシデントの通知

---

**作成日**: 2025年8月25日  
**バージョン**: 1.0  
**作成者**: AI Assistant
