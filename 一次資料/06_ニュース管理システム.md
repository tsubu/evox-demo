# ニュース管理システム仕様書

## 概要
EvoXシステムでは、管理者によるニュース投稿・管理システムを実装しています。ニュースの作成、編集、公開・非公開制御、フロントエンド表示機能を提供します。

## データベース設計

### ニューステーブル（game_news）
```sql
CREATE TABLE game_news (
    id BIGINT PRIMARY KEY,
    gamenews_title VARCHAR(255),
    gamenews_content TEXT,
    gamenews_is_published BOOLEAN DEFAULT FALSE,
    gamenews_published_at TIMESTAMP,
    gamenews_created_at TIMESTAMP,
    gamenews_updated_at TIMESTAMP
);
```

## 管理画面機能

### 1. ニュース一覧画面
**URL**: `/admin/news`

#### 機能
- **ニュース一覧表示**: 投稿済みニュースの一覧表示
- **統計情報**: ニュース統計の表示
- **検索・フィルタ**: ニュース検索機能
- **ページネーション**: 大量データの分割表示

#### 表示項目
- ID、タイトル、内容（一部）
- 公開状態、公開日、作成日
- 操作ボタン（編集、削除、公開/非公開）

#### 操作ボタン
- **編集**: ニュース内容の編集
- **削除**: ニュースの削除
- **公開/非公開**: 公開状態の切り替え

### 2. ニュース作成画面
**URL**: `/admin/news/create`

#### 機能
- **タイトル入力**: ニュースのタイトル
- **内容入力**: ニュースの本文（リッチテキスト対応）
- **公開設定**: 公開・非公開の設定
- **プレビュー**: 投稿前のプレビュー機能

#### 入力項目
- **タイトル**: ニュースのタイトル（255文字以内）
- **内容**: ニュースの本文（テキストエリア）
- **公開設定**: チェックボックスで公開/非公開切り替え

### 3. ニュース編集画面
**URL**: `/admin/news/{id}/edit`

#### 機能
- **既存データ表示**: 保存済みデータの表示・編集
- **内容編集**: タイトル・内容の編集
- **公開設定変更**: 公開状態の変更

## バックエンド実装

### コントローラー

#### NewsController
```php
class NewsController extends Controller
{
    public function index()                    // ニュース一覧表示
    public function create()                   // 作成画面表示
    public function store(Request $request)    // 作成処理
    public function edit($id)                  // 編集画面表示
    public function update(Request $request, $id) // 更新処理
    public function destroy($id)               // 削除処理
    public function togglePublish($id)         // 公開/非公開切り替え
}
```

### モデル

#### GameNews
```php
class GameNews extends Model
{
    protected $fillable = [
        'gamenews_title', 'gamenews_content',
        'gamenews_is_published', 'gamenews_published_at'
    ];

    protected $casts = [
        'gamenews_is_published' => 'boolean',
        'gamenews_published_at' => 'datetime'
    ];

    // 公開済みニュースのスコープ
    public function scopePublished($query)
    {
        return $query->where('gamenews_is_published', true);
    }

    // 最新ニュースのスコープ
    public function scopeLatest($query, $limit = 5)
    {
        return $query->published()->orderBy('gamenews_published_at', 'desc')->limit($limit);
    }
}
```

## API機能

### 1. 最新ニュース取得API
**URL**: `/api/news/latest`

#### 機能
- **最新ニュース**: 公開済みの最新ニュースを取得
- **件数制限**: デフォルト5件、パラメータで調整可能
- **JSON形式**: フロントエンド用のJSONレスポンス

#### レスポンス形式
```json
{
    "success": true,
    "data": [
        {
            "id": 1,
            "title": "ニュースタイトル",
            "content": "ニュース内容",
            "published_at": "2025-08-25T10:00:00Z",
            "created_at": "2025-08-25T09:00:00Z"
        }
    ]
}
```

### 2. 実装
```php
// APIコントローラー
public function latest(Request $request)
{
    $limit = $request->get('limit', 5);
    $news = GameNews::latest($limit)->get();
    
    return response()->json([
        'success' => true,
        'data' => $news->map(function ($item) {
            return [
                'id' => $item->id,
                'title' => $item->gamenews_title,
                'content' => $item->gamenews_content,
                'published_at' => $item->gamenews_published_at,
                'created_at' => $item->gamenews_created_at
            ];
        })
    ]);
}
```

## バリデーション

### 1. ニュース作成・更新時のバリデーション
```php
$request->validate([
    'gamenews_title' => 'required|string|max:255',
    'gamenews_content' => 'required|string',
    'gamenews_is_published' => 'boolean'
]);
```

## フロントエンド機能

### 1. ニュース一覧画面
```html
<!-- 統計情報 -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="info-box">
            <span class="info-box-icon bg-info">
                <i class="fas fa-newspaper"></i>
            </span>
            <div class="info-box-content">
                <span class="info-box-text">総ニュース数</span>
                <span class="info-box-number">{{ $news->count() }}</span>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="info-box">
            <span class="info-box-icon bg-success">
                <i class="fas fa-eye"></i>
            </span>
            <div class="info-box-content">
                <span class="info-box-text">公開中</span>
                <span class="info-box-number">{{ $publishedCount }}</span>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="info-box">
            <span class="info-box-icon bg-warning">
                <i class="fas fa-eye-slash"></i>
            </span>
            <div class="info-box-content">
                <span class="info-box-text">非公開</span>
                <span class="info-box-number">{{ $draftCount }}</span>
            </div>
        </div>
    </div>
</div>

<!-- ニュース一覧テーブル -->
<table class="table table-bordered table-striped">
    <thead>
        <tr>
            <th>ID</th>
            <th>タイトル</th>
            <th>内容</th>
            <th>公開状態</th>
            <th>公開日</th>
            <th>作成日</th>
            <th>操作</th>
        </tr>
    </thead>
    <tbody>
        @foreach($news as $item)
        <tr>
            <td>{{ $item->id }}</td>
            <td>{{ $item->gamenews_title }}</td>
            <td>{{ Str::limit($item->gamenews_content, 100) }}</td>
            <td>
                @if($item->gamenews_is_published)
                    <span class="badge badge-success">公開</span>
                @else
                    <span class="badge badge-warning">非公開</span>
                @endif
            </td>
            <td>
                @if($item->gamenews_published_at)
                    {{ $item->gamenews_published_at->format('Y年m月d日 H:i') }}
                @else
                    -
                @endif
            </td>
            <td>{{ $item->gamenews_created_at->format('Y年m月d日 H:i') }}</td>
            <td>
                <div class="btn-group" role="group">
                    <a href="{{ route('admin.news.edit', $item->id) }}" 
                       class="btn btn-sm btn-info">
                        <i class="fas fa-edit"></i> 編集
                    </a>
                    <button type="button" 
                            class="btn btn-sm btn-{{ $item->gamenews_is_published ? 'warning' : 'success' }}"
                            onclick="togglePublish({{ $item->id }})">
                        <i class="fas fa-{{ $item->gamenews_is_published ? 'eye-slash' : 'eye' }}"></i>
                        {{ $item->gamenews_is_published ? '非公開' : '公開' }}
                    </button>
                    <button type="button" 
                            class="btn btn-sm btn-danger"
                            onclick="deleteNews({{ $item->id }})">
                        <i class="fas fa-trash"></i> 削除
                    </button>
                </div>
            </td>
        </tr>
        @endforeach
    </tbody>
</table>
```

### 2. ニュース作成・編集画面
```html
<form action="{{ isset($news) ? route('admin.news.update', $news->id) : route('admin.news.store') }}" 
      method="POST">
    @csrf
    @if(isset($news))
        @method('PUT')
    @endif
    
    <div class="row">
        <div class="col-12">
            <div class="form-group">
                <label for="gamenews_title">タイトル <span class="text-danger">*</span></label>
                <input type="text" 
                       class="form-control @error('gamenews_title') is-invalid @enderror" 
                       id="gamenews_title" 
                       name="gamenews_title" 
                       value="{{ old('gamenews_title', $news->gamenews_title ?? '') }}" 
                       required 
                       maxlength="255">
                @error('gamenews_title')
                    <div class="invalid-feedback">{{ $message }}</div>
                @enderror
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="form-group">
                <label for="gamenews_content">内容 <span class="text-danger">*</span></label>
                <textarea class="form-control @error('gamenews_content') is-invalid @enderror" 
                          id="gamenews_content" 
                          name="gamenews_content" 
                          rows="10" 
                          required>{{ old('gamenews_content', $news->gamenews_content ?? '') }}</textarea>
                @error('gamenews_content')
                    <div class="invalid-feedback">{{ $message }}</div>
                @enderror
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="form-group">
                <div class="custom-control custom-checkbox">
                    <input type="checkbox" 
                           class="custom-control-input" 
                           id="gamenews_is_published" 
                           name="gamenews_is_published" 
                           value="1" 
                           {{ old('gamenews_is_published', $news->gamenews_is_published ?? false) ? 'checked' : '' }}>
                    <label class="custom-control-label" for="gamenews_is_published">
                        公開する
                    </label>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> {{ isset($news) ? '更新' : '作成' }}
            </button>
            <a href="{{ route('admin.news') }}" class="btn btn-secondary">
                <i class="fas fa-times"></i> キャンセル
            </a>
        </div>
    </div>
</form>
```

### 3. JavaScript機能
```javascript
// 公開/非公開切り替え
function togglePublish(newsId) {
    if (confirm('公開状態を切り替えますか？')) {
        fetch(`/admin/news/${newsId}/toggle-publish`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('エラーが発生しました。');
            }
        });
    }
}

// ニュース削除
function deleteNews(newsId) {
    if (confirm('このニュースを削除しますか？\n\nこの操作は取り消せません。')) {
        fetch(`/admin/news/${newsId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('エラーが発生しました。');
            }
        });
    }
}

// 文字数カウンター
function updateCharCount() {
    const title = document.getElementById('gamenews_title');
    const content = document.getElementById('gamenews_content');
    const titleCount = title.value.length;
    const contentCount = content.value.length;
    
    // タイトル文字数表示
    const titleCounter = document.getElementById('title-char-count');
    if (titleCounter) {
        titleCounter.textContent = `${titleCount}/255`;
        titleCounter.className = titleCount > 255 ? 'text-danger' : 'text-muted';
    }
    
    // 内容文字数表示
    const contentCounter = document.getElementById('content-char-count');
    if (contentCounter) {
        contentCounter.textContent = `${contentCount}文字`;
    }
}
```

## 統計機能

### 1. ニュース統計
- **総ニュース数**: 投稿済みニュースの総数
- **公開中**: 公開中のニュース数
- **非公開**: 非公開のニュース数
- **今月投稿**: 今月投稿されたニュース数

### 2. 実装
```php
// ニュース統計の取得
$stats = [
    'total_news' => GameNews::count(),
    'published_news' => GameNews::where('gamenews_is_published', true)->count(),
    'draft_news' => GameNews::where('gamenews_is_published', false)->count(),
    'this_month' => GameNews::whereMonth('gamenews_created_at', now()->month)->count(),
];
```

## セキュリティ機能

### 1. アクセス制御
- **管理者認証**: セッションベース認証
- **CSRF保護**: 全フォームでCSRFトークン検証
- **権限チェック**: ミドルウェアによる権限制御

### 2. データ検証
- **入力値検証**: 厳密なバリデーション
- **XSS対策**: Bladeテンプレートエンジンによる自動エスケープ
- **SQLインジェクション対策**: Eloquent ORM

## エラーハンドリング

### 1. バリデーションエラー
- **必須項目**: タイトル・内容の必須チェック
- **文字数制限**: タイトルの文字数制限（255文字）
- **形式チェック**: 入力値の形式検証

### 2. システムエラー
- **データベースエラー**: データベース操作エラーの処理
- **ファイル操作エラー**: ファイルアップロードエラーの処理

## ログ機能

### 1. ニュース操作ログ
```php
// ニュース作成
\Log::info('News created', [
    'news_id' => $news->id,
    'title' => $news->gamenews_title,
    'admin_id' => Auth::guard('admin')->id()
]);

// ニュース更新
\Log::info('News updated', [
    'news_id' => $news->id,
    'title' => $news->gamenews_title,
    'admin_id' => Auth::guard('admin')->id()
]);

// ニュース削除
\Log::warning('News deleted', [
    'news_id' => $news->id,
    'title' => $news->gamenews_title,
    'admin_id' => Auth::guard('admin')->id()
]);

// 公開状態変更
\Log::info('News publish status changed', [
    'news_id' => $news->id,
    'status' => $news->gamenews_is_published ? 'published' : 'unpublished',
    'admin_id' => Auth::guard('admin')->id()
]);
```

## テスト機能

### 1. ニュース作成テスト
```php
public function test_news_creation()
{
    $response = $this->post('/admin/news', [
        'gamenews_title' => 'テストニュース',
        'gamenews_content' => 'これはテストニュースです。',
        'gamenews_is_published' => true
    ]);
    
    $response->assertStatus(302);
    $this->assertDatabaseHas('game_news', [
        'gamenews_title' => 'テストニュース',
        'gamenews_content' => 'これはテストニュースです。',
        'gamenews_is_published' => true
    ]);
}
```

### 2. APIテスト
```php
public function test_latest_news_api()
{
    $news = GameNews::factory()->create([
        'gamenews_is_published' => true,
        'gamenews_published_at' => now()
    ]);
    
    $response = $this->get('/api/news/latest');
    
    $response->assertStatus(200);
    $response->assertJson([
        'success' => true,
        'data' => [
            [
                'id' => $news->id,
                'title' => $news->gamenews_title,
                'content' => $news->gamenews_content
            ]
        ]
    ]);
}
```

## 運用・保守

### 1. 定期メンテナンス
- **古いニュース**: 古いニュースのアーカイブ化
- **ログローテーション**: ニュース操作ログの定期整理
- **統計更新**: ニュース統計の定期更新

### 2. コンテンツ管理
- **品質管理**: ニュース内容の品質チェック
- **公開スケジュール**: 公開スケジュールの管理
- **バックアップ**: ニュースデータの定期バックアップ

---

**作成日**: 2025年8月25日  
**バージョン**: 1.0  
**作成者**: AI Assistant
