# 統計・ダッシュボードシステム仕様書

## 概要
EvoXシステムでは、システム全体の統計情報を表示するダッシュボード機能を実装しています。ユーザー、QRコード、ニュース、管理者の統計情報をリアルタイムで表示します。

## ダッシュボード機能

### 1. メインダッシュボード
**URL**: `/admin/dashboard`

#### 機能
- **システム概要**: システム全体の統計情報
- **リアルタイム更新**: 最新の統計データの表示
- **視覚的表示**: グラフ・チャートによる統計表示
- **クイックアクセス**: 各管理画面へのショートカット

#### 表示項目
- **ユーザー統計**: 総ユーザー数、アクティブユーザー数
- **QRコード統計**: 総QRコード数、使用回数
- **ニュース統計**: 総ニュース数、公開中ニュース数
- **管理者統計**: 総管理者数

### 2. 統計情報画面
**URL**: `/admin/stats`

#### 機能
- **詳細統計**: 各項目の詳細な統計情報
- **期間別統計**: 日別・月別の統計データ
- **グラフ表示**: 統計データのグラフ化
- **エクスポート**: 統計データのCSV出力

## バックエンド実装

### コントローラー

#### StatsController
```php
class StatsController extends Controller
{
    public function index()                    // 統計情報表示
    public function dashboard()                // ダッシュボード表示
    public function export()                   // 統計データエクスポート
    public function api()                      // API用統計データ
}
```

### 統計データ取得

#### 1. ユーザー統計
```php
// ユーザー統計の取得
$userStats = [
    'total_users' => User::count(),
    'active_users' => User::where('user_is_active', true)->count(),
    'inactive_users' => User::where('user_is_active', false)->count(),
    'blacklisted_users' => User::where('user_is_blacklisted', true)->count(),
    'new_users_today' => User::whereDate('user_created_at', today())->count(),
    'new_users_this_month' => User::whereMonth('user_created_at', now()->month)->count(),
];
```

#### 2. QRコード統計
```php
// QRコード統計の取得
$qrStats = [
    'total_qr_codes' => QrCode::count(),
    'event_qr_codes' => QrCode::where('qr_is_liveevent', true)->count(),
    'goods_qr_codes' => QrCode::where('qr_is_liveevent', false)->count(),
    'active_qr_codes' => QrCode::where('qr_is_active', true)->count(),
    'inactive_qr_codes' => QrCode::where('qr_is_active', false)->count(),
    'qr_codes_with_options' => QrCode::where('qr_options_enabled', true)->count(),
    'total_qr_usage' => QrUseList::count(),
    'today_qr_usage' => QrUseList::whereDate('qruse_created_at', today())->count(),
    'monthly_qr_usage' => QrUseList::whereMonth('qruse_created_at', now()->month)->count(),
];
```

#### 3. ニュース統計
```php
// ニュース統計の取得
$newsStats = [
    'total_news' => GameNews::count(),
    'published_news' => GameNews::where('gamenews_is_published', true)->count(),
    'draft_news' => GameNews::where('gamenews_is_published', false)->count(),
    'news_this_month' => GameNews::whereMonth('gamenews_created_at', now()->month)->count(),
];
```

#### 4. 管理者統計
```php
// 管理者統計の取得
$adminStats = [
    'total_admins' => UserAdmin::count(),
    'active_admins' => UserAdmin::count(), // 全管理者がアクティブ
];
```

## フロントエンド機能

### 1. ダッシュボード画面
```html
<!-- 統計カード -->
<div class="row">
    <!-- ユーザー統計 -->
    <div class="col-lg-3 col-6">
        <div class="small-box bg-info">
            <div class="inner">
                <h3>{{ $userStats['total_users'] }}</h3>
                <p>総ユーザー数</p>
            </div>
            <div class="icon">
                <i class="fas fa-users"></i>
            </div>
            <a href="{{ route('admin.users') }}" class="small-box-footer">
                詳細を見る <i class="fas fa-arrow-circle-right"></i>
            </a>
        </div>
    </div>

    <!-- QRコード統計 -->
    <div class="col-lg-3 col-6">
        <div class="small-box bg-success">
            <div class="inner">
                <h3>{{ $qrStats['total_qr_codes'] }}</h3>
                <p>総QRコード数</p>
            </div>
            <div class="icon">
                <i class="fas fa-qrcode"></i>
            </div>
            <a href="{{ route('admin.qrcodes') }}" class="small-box-footer">
                詳細を見る <i class="fas fa-arrow-circle-right"></i>
            </a>
        </div>
    </div>

    <!-- ニュース統計 -->
    <div class="col-lg-3 col-6">
        <div class="small-box bg-warning">
            <div class="inner">
                <h3>{{ $newsStats['total_news'] }}</h3>
                <p>総ニュース数</p>
            </div>
            <div class="icon">
                <i class="fas fa-newspaper"></i>
            </div>
            <a href="{{ route('admin.news') }}" class="small-box-footer">
                詳細を見る <i class="fas fa-arrow-circle-right"></i>
            </a>
        </div>
    </div>

    <!-- 管理者統計 -->
    <div class="col-lg-3 col-6">
        <div class="small-box bg-danger">
            <div class="inner">
                <h3>{{ $adminStats['total_admins'] }}</h3>
                <p>総管理者数</p>
            </div>
            <div class="icon">
                <i class="fas fa-users-cog"></i>
            </div>
            <a href="{{ route('admin.admins') }}" class="small-box-footer">
                詳細を見る <i class="fas fa-arrow-circle-right"></i>
            </a>
        </div>
    </div>
</div>

<!-- 詳細統計 -->
<div class="row">
    <!-- ユーザー詳細統計 -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-users"></i> ユーザー統計
                </h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-6">
                        <div class="info-box bg-light">
                            <div class="info-box-content">
                                <span class="info-box-text">アクティブユーザー</span>
                                <span class="info-box-number">{{ $userStats['active_users'] }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="info-box bg-light">
                            <div class="info-box-content">
                                <span class="info-box-text">ブラックリスト</span>
                                <span class="info-box-number">{{ $userStats['blacklisted_users'] }}</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-6">
                        <div class="info-box bg-light">
                            <div class="info-box-content">
                                <span class="info-box-text">今日の新規</span>
                                <span class="info-box-number">{{ $userStats['new_users_today'] }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="info-box bg-light">
                            <div class="info-box-content">
                                <span class="info-box-text">今月の新規</span>
                                <span class="info-box-number">{{ $userStats['new_users_this_month'] }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- QRコード詳細統計 -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-qrcode"></i> QRコード統計
                </h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-6">
                        <div class="info-box bg-light">
                            <div class="info-box-content">
                                <span class="info-box-text">リアルイベント</span>
                                <span class="info-box-number">{{ $qrStats['event_qr_codes'] }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="info-box bg-light">
                            <div class="info-box-content">
                                <span class="info-box-text">ゲームグッズ</span>
                                <span class="info-box-number">{{ $qrStats['goods_qr_codes'] }}</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-6">
                        <div class="info-box bg-light">
                            <div class="info-box-content">
                                <span class="info-box-text">総使用回数</span>
                                <span class="info-box-number">{{ $qrStats['total_qr_usage'] }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="info-box bg-light">
                            <div class="info-box-content">
                                <span class="info-box-text">今日の使用</span>
                                <span class="info-box-number">{{ $qrStats['today_qr_usage'] }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- アクションカード -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-tools"></i> クイックアクション
                </h3>
            </div>
            <div class="card-body">
                <div class="actions-grid">
                    <div class="action-card">
                        <h3>ユーザー管理</h3>
                        <p>ユーザーアカウントの管理を行います。</p>
                        <a href="{{ route('admin.users') }}" class="action-btn">ユーザー管理</a>
                    </div>
                    <div class="action-card">
                        <h3>QRコード管理</h3>
                        <p>QRコードの作成、編集、管理を行います。</p>
                        <a href="{{ route('admin.qrcodes') }}" class="action-btn">QRコード管理</a>
                    </div>
                    <div class="action-card">
                        <h3>ニュース管理</h3>
                        <p>ニュースの投稿、編集、管理を行います。</p>
                        <a href="{{ route('admin.news') }}" class="action-btn">ニュース管理</a>
                    </div>
                    <div class="action-card">
                        <h3>管理者管理</h3>
                        <p>管理者アカウントの追加、編集、削除を行います。</p>
                        <a href="{{ route('admin.admins') }}" class="action-btn">管理者管理</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
```

### 2. 統計情報画面
```html
<!-- 期間選択 -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="form-group">
            <label for="period">期間選択</label>
            <select class="form-control" id="period" onchange="updateStats()">
                <option value="today">今日</option>
                <option value="week">今週</option>
                <option value="month" selected>今月</option>
                <option value="year">今年</option>
                <option value="all">全期間</option>
            </select>
        </div>
    </div>
    <div class="col-md-6">
        <div class="form-group">
            <label>&nbsp;</label>
            <div>
                <button type="button" class="btn btn-success" onclick="exportStats()">
                    <i class="fas fa-download"></i> CSV出力
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 統計グラフ -->
<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">ユーザー登録推移</h3>
            </div>
            <div class="card-body">
                <canvas id="userChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">QRコード使用推移</h3>
            </div>
            <div class="card-body">
                <canvas id="qrChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
</div>
```

### 3. JavaScript機能
```javascript
// 統計データの更新
function updateStats() {
    const period = document.getElementById('period').value;
    
    fetch(`/admin/stats/api?period=${period}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateCharts(data.data);
                updateStatsDisplay(data.data);
            }
        });
}

// グラフの更新
function updateCharts(data) {
    // ユーザー登録推移グラフ
    const userCtx = document.getElementById('userChart').getContext('2d');
    new Chart(userCtx, {
        type: 'line',
        data: {
            labels: data.user_chart.labels,
            datasets: [{
                label: '新規ユーザー',
                data: data.user_chart.data,
                borderColor: 'rgb(75, 192, 192)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // QRコード使用推移グラフ
    const qrCtx = document.getElementById('qrChart').getContext('2d');
    new Chart(qrCtx, {
        type: 'bar',
        data: {
            labels: data.qr_chart.labels,
            datasets: [{
                label: 'QRコード使用回数',
                data: data.qr_chart.data,
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                borderColor: 'rgb(54, 162, 235)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

// 統計表示の更新
function updateStatsDisplay(data) {
    // 統計カードの更新
    document.getElementById('total-users').textContent = data.user_stats.total_users;
    document.getElementById('active-users').textContent = data.user_stats.active_users;
    document.getElementById('total-qr-codes').textContent = data.qr_stats.total_qr_codes;
    document.getElementById('total-usage').textContent = data.qr_stats.total_qr_usage;
}

// 統計データのエクスポート
function exportStats() {
    const period = document.getElementById('period').value;
    
    fetch(`/admin/stats/export?period=${period}`)
        .then(response => response.blob())
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `stats_${period}_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        });
}

// 自動更新（5分間隔）
setInterval(updateStats, 300000);
```

## API機能

### 1. 統計データAPI
**URL**: `/admin/stats/api`

#### 機能
- **期間別統計**: 指定期間の統計データ取得
- **グラフデータ**: グラフ表示用のデータ取得
- **JSON形式**: フロントエンド用のJSONレスポンス

#### レスポンス形式
```json
{
    "success": true,
    "data": {
        "user_stats": {
            "total_users": 100,
            "active_users": 95,
            "new_users_today": 5,
            "new_users_this_month": 25
        },
        "qr_stats": {
            "total_qr_codes": 50,
            "event_qr_codes": 30,
            "goods_qr_codes": 20,
            "total_qr_usage": 500
        },
        "user_chart": {
            "labels": ["1日", "2日", "3日", "4日", "5日"],
            "data": [10, 15, 8, 12, 20]
        },
        "qr_chart": {
            "labels": ["1日", "2日", "3日", "4日", "5日"],
            "data": [50, 75, 60, 80, 100]
        }
    }
}
```

### 2. エクスポートAPI
**URL**: `/admin/stats/export`

#### 機能
- **CSV出力**: 統計データのCSVファイル出力
- **期間指定**: 指定期間のデータ出力
- **ファイルダウンロード**: ブラウザでのファイルダウンロード

## セキュリティ機能

### 1. アクセス制御
- **管理者認証**: セッションベース認証
- **権限チェック**: ミドルウェアによる権限制御
- **API保護**: 認証済み管理者のみアクセス可能

### 2. データ保護
- **個人情報**: 個人情報の適切な取り扱い
- **統計データ**: 統計データの正確性確保
- **ログ記録**: 統計アクセスのログ記録

## パフォーマンス最適化

### 1. データベース最適化
- **インデックス**: 統計クエリ用のインデックス設定
- **クエリ最適化**: 効率的な統計クエリの実装
- **キャッシュ**: 統計データのキャッシュ機能

### 2. フロントエンド最適化
- **非同期更新**: JavaScriptによる非同期データ更新
- **グラフ最適化**: Chart.jsによる効率的なグラフ表示
- **レスポンシブ**: モバイル対応の最適化

## 運用・保守

### 1. 定期メンテナンス
- **統計データ**: 統計データの定期更新
- **グラフ更新**: グラフデータの定期更新
- **ログ管理**: 統計アクセスログの管理

### 2. 監視機能
- **データ整合性**: 統計データの整合性チェック
- **パフォーマンス**: 統計表示のパフォーマンス監視
- **エラー検知**: 統計機能のエラー検知

---

**作成日**: 2025年8月25日  
**バージョン**: 1.0  
**作成者**: AI Assistant
