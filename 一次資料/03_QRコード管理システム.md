# QRコード管理システム仕様書

## 概要
EvoXシステムでは、リアルイベントとゲームグッズ（仮）の2種類のQRコードを管理するシステムを実装しています。各QRコードにはオプション機能が付属し、ユーザーのカスタマイズ体験を提供します。

## QRコード種類

### 1. リアルイベントQRコード
- **用途**: ライブイベント、コンサート、フェスティバル等
- **特徴**: 
  - ライブイベントフラグ自動設定（`qr_is_liveevent = true`）
  - 複数回参加不可（`qr_is_multiple = false`）
  - アーティスト名設定可能
  - オプション機能対応

### 2. ゲームグッズ（仮）QRコード
- **用途**: 仮想アイテム、アバター、ポイント等
- **特徴**:
  - 複数回使用可能設定
  - ポイント付与機能
  - 有効期限設定
  - オプション機能対応

## データベース設計

### QRコードテーブル（qr_codes）
```sql
CREATE TABLE qr_codes (
    id BIGINT PRIMARY KEY,
    qr_code VARCHAR(255) UNIQUE,
    qr_title VARCHAR(255),
    qr_description TEXT,
    qr_is_liveevent BOOLEAN DEFAULT FALSE,
    qr_artist_name VARCHAR(255),
    qr_contents TEXT,
    qr_points INTEGER DEFAULT 0,
    qr_is_active BOOLEAN DEFAULT TRUE,
    qr_is_multiple BOOLEAN DEFAULT FALSE,
    qr_expires_at TIMESTAMP,
    qr_created_at TIMESTAMP,
    qr_updated_at TIMESTAMP,
    
    -- オプション機能フィールド
    qr_avatar_expressions JSON,
    qr_avatar_actions JSON,
    qr_background_colors JSON,
    qr_effects JSON,
    qr_sounds JSON,
    qr_options_enabled BOOLEAN DEFAULT FALSE
);
```

### QR使用履歴テーブル（qr_use_list）
```sql
CREATE TABLE qr_use_list (
    id BIGINT PRIMARY KEY,
    qruse_user_id BIGINT,
    qruse_qr_code_id BIGINT,
    qruse_points_earned INTEGER,
    qruse_claimed_at TIMESTAMP,
    qruse_created_at TIMESTAMP,
    qruse_updated_at TIMESTAMP,
    
    -- オプション選択結果
    qruse_selected_expression VARCHAR(100),
    qruse_selected_action VARCHAR(100),
    qruse_selected_background VARCHAR(100),
    qruse_selected_effect VARCHAR(100),
    qruse_selected_sound VARCHAR(100),
    qruse_options_selected_at TIMESTAMP
);
```

## 管理画面機能

### 1. QRコード一覧画面
**URL**: `/admin/qrcodes`

#### 機能
- **タブ分け**: リアルイベントとゲームグッズ（仮）を分けて表示
- **統計情報**: 各カテゴリの統計表示
- **オプション状態**: 各QRコードのオプション有効/無効状態
- **操作ボタン**: 詳細、編集、ダウンロード（PNG/SVG）

#### 表示項目
- ID、QRコード、タイトル、説明
- ポイント、有効期限、状態
- オプション状態（有効/無効、選択肢数）

### 2. QRコード作成画面
**URL**: `/admin/qrcodes/create`

#### 機能
- **タブ分け**: リアルイベントとゲームグッズ（仮）の作成フォーム
- **オプション設定**: チェックボックスで有効/無効切り替え
- **動的フォーム**: 最大5種類までオプション追加・削除
- **自動生成**: QRコード文字列の自動生成機能

#### 入力項目
- **基本情報**: QRコード、タイトル、説明
- **リアルイベント**: アーティスト名、イベント内容
- **ゲームグッズ**: ポイント、有効期限、複数回使用
- **オプション**: アバター表情、行動、背景色、エフェクト、サウンド

### 3. QRコード編集画面
**URL**: `/admin/qrcodes/{id}/edit`

#### 機能
- **既存データ表示**: 保存済みデータの表示・編集
- **オプション編集**: 既存オプションの追加・削除・変更
- **削除機能**: 危険操作カードでの削除機能

### 4. QRコード詳細画面
**URL**: `/admin/qrcodes/{id}`

#### 機能
- **基本情報表示**: QRコードの詳細情報
- **QRコードプレビュー**: 生成されたQRコードの表示
- **ダウンロード機能**: PNG/SVG形式でのダウンロード
- **オプション情報**: 設定されたオプションの一覧表示

### 5. オプション管理画面（専用）
**URL**: `/admin/qrcode-options`

#### 機能
- **デフォルト選択肢**: 現在のデフォルト選択肢を表示
- **カスタム選択肢**: 選択肢の追加・編集・削除（最大10種類）
- **一括操作**: 複数QRコードへの一括適用・制御

## バックエンド実装

### コントローラー

#### QrCodeController
```php
class QrCodeController extends Controller
{
    public function index()                    // 一覧表示
    public function create()                   // 作成画面表示
    public function store(Request $request)    // 作成処理
    public function show($id)                  // 詳細表示
    public function edit($id)                  // 編集画面表示
    public function update(Request $request, $id) // 更新処理
    public function destroy($id)               // 削除処理
    public function generate()                 // QRコード自動生成
    public function downloadPng($id)           // PNGダウンロード
    public function downloadSvg($id)           // SVGダウンロード
}
```

#### QrCodeOptionsController
```php
class QrCodeOptionsController extends Controller
{
    public function index()                    // オプション管理画面
    public function applyDefaults()            // デフォルト適用
    public function updateCustomOptions()      // カスタム更新
    public function toggleOptions()            // 一括有効/無効化
}
```

### モデル

#### QrCode
```php
class QrCode extends Model
{
    protected $fillable = [
        'qr_code', 'qr_title', 'qr_description',
        'qr_is_liveevent', 'qr_artist_name', 'qr_contents',
        'qr_points', 'qr_is_active', 'qr_is_multiple',
        'qr_expires_at',
        // オプション機能
        'qr_avatar_expressions', 'qr_avatar_actions',
        'qr_background_colors', 'qr_effects', 'qr_sounds',
        'qr_options_enabled'
    ];

    protected $casts = [
        'qr_is_liveevent' => 'boolean',
        'qr_is_active' => 'boolean',
        'qr_is_multiple' => 'boolean',
        'qr_expires_at' => 'datetime',
        'qr_avatar_expressions' => 'array',
        'qr_avatar_actions' => 'array',
        'qr_background_colors' => 'array',
        'qr_effects' => 'array',
        'qr_sounds' => 'array',
        'qr_options_enabled' => 'boolean'
    ];
}
```

### バリデーション
```php
// QRコード作成・更新時のバリデーション
$request->validate([
    'qr_code' => 'required|string|unique:qr_codes,qr_code',
    'qr_description' => 'required|string|max:255',
    'qr_title' => 'required|string|max:255',
    'qr_points' => 'nullable|integer|min:0',
    'qr_artist_name' => 'nullable|string|max:255',
    'qr_expires_at' => 'nullable|date',
    'qr_contents' => 'nullable|string',
    'qr_is_active' => 'boolean',
    'qr_is_liveevent' => 'boolean',
    'qr_is_multiple' => 'boolean',
    'qr_type' => 'required|in:event,goods',
    // オプション関連
    'qr_options_enabled' => 'boolean',
    'qr_avatar_expressions' => 'nullable|array|max:5',
    'qr_avatar_expressions.*' => 'nullable|string|max:100',
    'qr_avatar_actions' => 'nullable|array|max:5',
    'qr_avatar_actions.*' => 'nullable|string|max:100',
    'qr_background_colors' => 'nullable|array|max:5',
    'qr_background_colors.*' => 'nullable|string|max:100',
    'qr_effects' => 'nullable|array|max:5',
    'qr_effects.*' => 'nullable|string|max:100',
    'qr_sounds' => 'nullable|array|max:5',
    'qr_sounds.*' => 'nullable|string|max:100'
]);
```

## オプション機能

### デフォルト選択肢
```php
$defaultOptions = [
    'qr_avatar_expressions' => ['笑顔', '怒り', '悲しみ', '驚き', '普通'],
    'qr_avatar_actions' => ['ダンス', 'ジャンプ', '手を振る', '座る', '走る'],
    'qr_background_colors' => ['青空', '夕日', '星空', '森', '海'],
    'qr_effects' => ['キラキラ', '虹', '花火', '雪', '雨'],
    'qr_sounds' => ['ファンファーレ', '拍手', '音楽', '効果音', '無音']
];
```

### オプション管理機能
- **有効/無効切り替え**: チェックボックスで制御
- **動的追加**: 最大5種類まで追加可能
- **個別削除**: 不要な選択肢を削除
- **一括更新**: オプション有効な全QRコードに適用

## QRコード生成・ダウンロード

### QRコード生成サービス
```php
class QrCodeService
{
    public function generatePng(string $data, int $size = 300): string
    public function generateSvg(string $data, int $size = 300): string
    public function saveQrCode(string $data, string $filename, string $format = 'png'): string
}
```

### ダウンロード機能
- **PNG形式**: ラスター画像形式
- **SVG形式**: ベクター画像形式（拡大縮小可能）
- **ファイル名**: `qr_{QRコード}.png/svg`

## フロントエンド機能

### JavaScript機能
```javascript
// QRコード自動生成
function generateQrCode(elementId)

// オプション機能の表示/非表示切り替え
function toggleOptionsSection(type)

// オプション項目の追加
function addOption(containerId, name, label)

// オプション項目の削除
function removeOption(button)

// カスタムオプションの追加
function addCustomOption(containerId, name, label)

// カスタムオプションの削除
function removeCustomOption(button)
```

### UI/UX特徴
- **タブ分け**: リアルイベントとゲームグッズ（仮）を分離
- **動的フォーム**: オプション項目の動的追加・削除
- **視覚的フィードバック**: カード形式、アイコン、色分け
- **レスポンシブデザイン**: モバイル対応

## 統計機能

### QRコード統計
- **リアルイベント総数**: リアルイベントQRコード数
- **ゲームグッズ総数**: ゲームグッズQRコード数
- **アクティブ**: アクティブなQRコード数
- **非アクティブ**: 非アクティブなQRコード数
- **オプション有効**: オプション機能が有効なQRコード数

### 使用統計
- **総使用回数**: QRコードの総使用回数
- **ポイント付与**: 総ポイント付与数
- **ユーザー別使用**: ユーザー別の使用状況

## セキュリティ

### アクセス制御
- **管理者認証**: セッションベース認証
- **CSRF保護**: 全フォームでCSRFトークン検証
- **権限チェック**: ミドルウェアによる権限制御

### データ検証
- **入力値検証**: 厳密なバリデーション
- **SQLインジェクション対策**: Eloquent ORM
- **XSS対策**: Bladeテンプレートエンジン

## 今後の拡張予定

### フロントエンド連携
- **API設計**: オプション選択用API
- **選択UI**: ユーザー向け選択画面
- **結果保存**: 選択結果のデータベース保存

### 拡張機能
- **テーマ別選択肢**: イベントテーマに応じた選択肢
- **季節限定**: 季節に応じた選択肢の自動切り替え
- **統計分析**: 選択傾向の分析・レポート機能

---

**作成日**: 2025年8月25日  
**バージョン**: 1.0  
**作成者**: AI Assistant
