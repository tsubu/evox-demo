# 管理者管理システム仕様書

## 概要
EvoXシステムでは、管理者アカウントの作成・編集・削除を行う管理システムを実装しています。管理者の権限管理とセキュリティ機能を提供します。

## データベース設計

### 管理者テーブル（user_admins）
```sql
CREATE TABLE user_admins (
    id BIGINT PRIMARY KEY,
    admin_name VARCHAR(255),
    admin_phone VARCHAR(20) UNIQUE,
    admin_email VARCHAR(255) UNIQUE,
    admin_password VARCHAR(255),
    admin_created_at TIMESTAMP,
    admin_updated_at TIMESTAMP
);
```

## 管理画面機能

### 1. 管理者一覧画面
**URL**: `/admin/admins`

#### 機能
- **管理者一覧表示**: 登録管理者の一覧表示
- **統計情報**: 管理者統計の表示
- **検索・フィルタ**: 管理者検索機能
- **ページネーション**: 大量データの分割表示

#### 表示項目
- ID、名前、電話番号、メールアドレス
- 作成日、最終更新日
- 操作ボタン（編集、削除）

#### 操作ボタン
- **編集**: 管理者情報の編集
- **削除**: 管理者アカウントの削除（自己削除防止）

### 2. 管理者作成画面
**URL**: `/admin/admins/create`

#### 機能
- **基本情報入力**: 名前、電話番号、メールアドレス
- **パスワード設定**: パスワードとパスワード確認
- **バリデーション**: 入力値の検証

#### 入力項目
- **名前**: 管理者の表示名
- **電話番号**: SMS認証用の電話番号
- **メールアドレス**: 連絡用メールアドレス
- **パスワード**: ログイン用パスワード（8文字以上）
- **パスワード確認**: パスワードの再入力

### 3. 管理者編集画面
**URL**: `/admin/admins/{id}/edit`

#### 機能
- **既存データ表示**: 保存済みデータの表示・編集
- **パスワード変更**: オプションでのパスワード変更
- **自己編集防止**: 自分以外の管理者のみ編集可能

#### 編集項目
- **基本情報**: 名前、電話番号、メールアドレス
- **パスワード**: オプションでのパスワード変更
- **パスワード確認**: 変更時のパスワード確認

## バックエンド実装

### コントローラー

#### AdminController
```php
class AdminController extends Controller
{
    public function index()                    // 管理者一覧表示
    public function create()                   // 作成画面表示
    public function store(Request $request)    // 作成処理
    public function edit($id)                  // 編集画面表示
    public function update(Request $request, $id) // 更新処理
    public function destroy($id)               // 削除処理
}
```

### モデル

#### UserAdmin
```php
class UserAdmin extends Model
{
    protected $fillable = [
        'admin_name', 'admin_phone', 'admin_email', 'admin_password'
    ];

    protected $hidden = [
        'admin_password'
    ];

    // パスワードハッシュ化
    public function setAdminPasswordAttribute($value)
    {
        $this->attributes['admin_password'] = Hash::make($value);
    }
}
```

## セキュリティ機能

### 1. 自己削除防止
```php
public function destroy($id)
{
    $admin = UserAdmin::findOrFail($id);
    
    // 自分自身の削除を防止
    if ($admin->id === Auth::guard('admin')->id()) {
        return redirect()->route('admin.admins')
            ->with('error', '自分自身のアカウントは削除できません。');
    }
    
    $admin->delete();
    return redirect()->route('admin.admins')
        ->with('success', '管理者を削除しました。');
}
```

### 2. パスワード管理
- **ハッシュ化**: Laravel標準のパスワードハッシュ化
- **強度チェック**: パスワード強度の検証（8文字以上）
- **変更履歴**: パスワード変更履歴の記録

### 3. 権限管理
- **アクセス制御**: 管理者認証によるアクセス制御
- **操作制限**: 自分以外の管理者のみ編集・削除可能
- **ログ記録**: 管理者操作のログ記録

## バリデーション

### 1. 作成時のバリデーション
```php
$request->validate([
    'admin_name' => 'required|string|max:255',
    'admin_phone' => 'required|string|unique:user_admins,admin_phone',
    'admin_email' => 'required|email|unique:user_admins,admin_email',
    'admin_password' => 'required|string|min:8|confirmed'
]);
```

### 2. 更新時のバリデーション
```php
$request->validate([
    'admin_name' => 'required|string|max:255',
    'admin_phone' => 'required|string|unique:user_admins,admin_phone,' . $id,
    'admin_email' => 'required|email|unique:user_admins,admin_email,' . $id,
    'admin_password' => 'nullable|string|min:8|confirmed'
]);
```

## フロントエンド機能

### 1. 管理者一覧画面
```html
<!-- 統計情報 -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="info-box">
            <span class="info-box-icon bg-info">
                <i class="fas fa-users-cog"></i>
            </span>
            <div class="info-box-content">
                <span class="info-box-text">総管理者数</span>
                <span class="info-box-number">{{ $admins->count() }}</span>
            </div>
        </div>
    </div>
</div>

<!-- 管理者一覧テーブル -->
<table class="table table-bordered table-striped">
    <thead>
        <tr>
            <th>ID</th>
            <th>名前</th>
            <th>電話番号</th>
            <th>メールアドレス</th>
            <th>作成日</th>
            <th>操作</th>
        </tr>
    </thead>
    <tbody>
        @foreach($admins as $admin)
        <tr>
            <td>{{ $admin->id }}</td>
            <td>{{ $admin->admin_name }}</td>
            <td>{{ $admin->admin_phone }}</td>
            <td>{{ $admin->admin_email }}</td>
            <td>{{ $admin->admin_created_at->format('Y年m月d日 H:i') }}</td>
            <td>
                <div class="btn-group" role="group">
                    <a href="{{ route('admin.admins.edit', $admin->id) }}" 
                       class="btn btn-sm btn-info">
                        <i class="fas fa-edit"></i> 編集
                    </a>
                    @if($admin->id !== Auth::guard('admin')->id())
                    <button type="button" 
                            class="btn btn-sm btn-danger"
                            onclick="deleteAdmin({{ $admin->id }})">
                        <i class="fas fa-trash"></i> 削除
                    </button>
                    @else
                    <button type="button" 
                            class="btn btn-sm btn-secondary" 
                            disabled 
                            title="自分自身は削除できません">
                        <i class="fas fa-trash"></i> 削除
                    </button>
                    @endif
                </div>
            </td>
        </tr>
        @endforeach
    </tbody>
</table>
```

### 2. 管理者作成画面
```html
<form action="{{ route('admin.admins.store') }}" method="POST">
    @csrf
    <div class="row">
        <div class="col-md-6">
            <div class="form-group">
                <label for="admin_name">名前 <span class="text-danger">*</span></label>
                <input type="text" 
                       class="form-control @error('admin_name') is-invalid @enderror" 
                       id="admin_name" 
                       name="admin_name" 
                       value="{{ old('admin_name') }}" 
                       required>
                @error('admin_name')
                    <div class="invalid-feedback">{{ $message }}</div>
                @enderror
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="form-group">
                <label for="admin_phone">電話番号 <span class="text-danger">*</span></label>
                <input type="text" 
                       class="form-control @error('admin_phone') is-invalid @enderror" 
                       id="admin_phone" 
                       name="admin_phone" 
                       value="{{ old('admin_phone') }}" 
                       required>
                @error('admin_phone')
                    <div class="invalid-feedback">{{ $message }}</div>
                @enderror
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="form-group">
                <label for="admin_email">メールアドレス <span class="text-danger">*</span></label>
                <input type="email" 
                       class="form-control @error('admin_email') is-invalid @enderror" 
                       id="admin_email" 
                       name="admin_email" 
                       value="{{ old('admin_email') }}" 
                       required>
                @error('admin_email')
                    <div class="invalid-feedback">{{ $message }}</div>
                @enderror
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="form-group">
                <label for="admin_password">パスワード <span class="text-danger">*</span></label>
                <input type="password" 
                       class="form-control @error('admin_password') is-invalid @enderror" 
                       id="admin_password" 
                       name="admin_password" 
                       required 
                       minlength="8">
                @error('admin_password')
                    <div class="invalid-feedback">{{ $message }}</div>
                @enderror
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="form-group">
                <label for="admin_password_confirmation">パスワード確認 <span class="text-danger">*</span></label>
                <input type="password" 
                       class="form-control" 
                       id="admin_password_confirmation" 
                       name="admin_password_confirmation" 
                       required 
                       minlength="8">
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> 管理者を作成
            </button>
            <a href="{{ route('admin.admins') }}" class="btn btn-secondary">
                <i class="fas fa-times"></i> キャンセル
            </a>
        </div>
    </div>
</form>
```

### 3. JavaScript機能
```javascript
// 管理者削除
function deleteAdmin(adminId) {
    if (confirm('この管理者を削除しますか？\n\nこの操作は取り消せません。')) {
        fetch(`/admin/admins/${adminId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.message || 'エラーが発生しました。');
            }
        });
    }
}

// パスワード強度チェック
function checkPasswordStrength(password) {
    let strength = 0;
    
    if (password.length >= 8) strength++;
    if (/[a-z]/.test(password)) strength++;
    if (/[A-Z]/.test(password)) strength++;
    if (/[0-9]/.test(password)) strength++;
    if (/[^A-Za-z0-9]/.test(password)) strength++;
    
    return strength;
}

// パスワード確認
function validatePassword() {
    const password = document.getElementById('admin_password').value;
    const confirmation = document.getElementById('admin_password_confirmation').value;
    
    if (password !== confirmation) {
        document.getElementById('admin_password_confirmation').setCustomValidity('パスワードが一致しません。');
    } else {
        document.getElementById('admin_password_confirmation').setCustomValidity('');
    }
}
```

## エラーハンドリング

### 1. バリデーションエラー
- **重複チェック**: 電話番号・メールアドレスの重複検証
- **形式チェック**: メールアドレス形式の検証
- **必須項目**: 必須項目の入力チェック
- **パスワード強度**: パスワード強度の検証

### 2. セキュリティエラー
- **自己削除**: 自分自身の削除試行の防止
- **権限不足**: 権限のない操作の制限
- **不正アクセス**: 不正なアクセスの検知

## ログ機能

### 1. 管理者操作ログ
```php
// 管理者作成
\Log::info('Admin created', [
    'admin_id' => $admin->id,
    'admin_name' => $admin->admin_name,
    'created_by' => Auth::guard('admin')->id()
]);

// 管理者更新
\Log::info('Admin updated', [
    'admin_id' => $admin->id,
    'admin_name' => $admin->admin_name,
    'updated_by' => Auth::guard('admin')->id()
]);

// 管理者削除
\Log::warning('Admin deleted', [
    'admin_id' => $admin->id,
    'admin_name' => $admin->admin_name,
    'deleted_by' => Auth::guard('admin')->id()
]);
```

## テスト機能

### 1. 管理者作成テスト
```php
public function test_admin_creation()
{
    $response = $this->post('/admin/admins', [
        'admin_name' => 'テスト管理者',
        'admin_phone' => '09012345678',
        'admin_email' => 'test@example.com',
        'admin_password' => 'password123',
        'admin_password_confirmation' => 'password123'
    ]);
    
    $response->assertStatus(302);
    $this->assertDatabaseHas('user_admins', [
        'admin_name' => 'テスト管理者',
        'admin_phone' => '09012345678',
        'admin_email' => 'test@example.com'
    ]);
}
```

### 2. 自己削除防止テスト
```php
public function test_self_deletion_prevention()
{
    $admin = UserAdmin::factory()->create();
    $this->actingAs($admin, 'admin');
    
    $response = $this->delete("/admin/admins/{$admin->id}");
    
    $response->assertStatus(302);
    $this->assertDatabaseHas('user_admins', ['id' => $admin->id]);
}
```

## 運用・保守

### 1. 定期メンテナンス
- **ログローテーション**: 管理者操作ログの定期整理
- **パスワード更新**: 定期的なパスワード更新の推奨
- **アクセス監査**: 管理者アクセスの定期監査

### 2. セキュリティ監視
- **不正アクセス**: 不正な管理者アクセスの検知
- **権限監視**: 権限の不正使用の検知
- **アカウント保護**: 管理者アカウントの乗っ取り検知

### 3. バックアップ
- **管理者データ**: 管理者情報の定期バックアップ
- **設定ファイル**: 認証設定のバックアップ
- **復旧手順**: 障害時の復旧手順書

---

**作成日**: 2025年8月25日  
**バージョン**: 1.0  
**作成者**: AI Assistant
