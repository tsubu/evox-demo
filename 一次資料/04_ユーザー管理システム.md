# ユーザー管理システム仕様書

## 概要
EvoXシステムでは、電話番号ベースのユーザー登録・管理システムを実装しています。ユーザーの基本情報、アカウント状態、ブラックリスト機能を提供します。

## データベース設計

### ユーザーテーブル（users）
```sql
CREATE TABLE users (
    id BIGINT PRIMARY KEY,
    user_phone VARCHAR(20) UNIQUE,
    user_name VARCHAR(255),
    user_email VARCHAR(255),
    user_password VARCHAR(255),
    user_is_active BOOLEAN DEFAULT TRUE,
    user_is_blacklisted BOOLEAN DEFAULT FALSE,
    user_email_verified_at TIMESTAMP,
    user_created_at TIMESTAMP,
    user_updated_at TIMESTAMP
);
```

### ユーザー登録テーブル（user_registrations）
```sql
CREATE TABLE user_registrations (
    id BIGINT PRIMARY KEY,
    reg_phone VARCHAR(20),
    reg_name VARCHAR(255),
    reg_email VARCHAR(255),
    reg_password VARCHAR(255),
    reg_is_verified BOOLEAN DEFAULT FALSE,
    reg_verification_code VARCHAR(6),
    reg_expires_at TIMESTAMP,
    reg_created_at TIMESTAMP,
    reg_updated_at TIMESTAMP
);
```

## 管理画面機能

### 1. ユーザー一覧画面
**URL**: `/admin/users`

#### 機能
- **ユーザー一覧表示**: 登録ユーザーの一覧表示
- **統計情報**: ユーザー統計の表示
- **検索・フィルタ**: ユーザー検索機能
- **ページネーション**: 大量データの分割表示

#### 表示項目
- ID、電話番号、名前、メールアドレス
- 登録日、最終ログイン日
- アカウント状態（アクティブ/非アクティブ）
- ブラックリスト状態

#### 操作ボタン
- **詳細**: ユーザー詳細情報の表示
- **削除**: ユーザーアカウントの削除
- **BKL**: ブラックリストの有効/無効切り替え

### 2. ユーザー詳細画面
**URL**: `/admin/users/{id}`

#### 機能
- **基本情報表示**: ユーザーの基本情報
- **アカウント情報**: アカウント状態、認証情報
- **使用履歴**: QRコード使用履歴の表示

#### 表示項目
- **基本情報**: 名前、電話番号、メールアドレス
- **アカウント情報**: 登録日、メール認証日、最終更新日
- **アカウント状態**: アクティブ/非アクティブ、ブラックリスト状態

## バックエンド実装

### コントローラー

#### UserController
```php
class UserController extends Controller
{
    public function index()                    // ユーザー一覧表示
    public function show($id)                  // ユーザー詳細表示
    public function destroy($id)               // ユーザー削除
    public function toggleBlacklist($id)       // ブラックリスト切り替え
}
```

### モデル

#### User
```php
class User extends Model
{
    protected $fillable = [
        'user_phone', 'user_name', 'user_email',
        'user_password', 'user_is_active',
        'user_is_blacklisted', 'user_email_verified_at'
    ];

    protected $casts = [
        'user_is_active' => 'boolean',
        'user_is_blacklisted' => 'boolean',
        'user_email_verified_at' => 'datetime'
    ];

    // リレーション
    public function qrUseList()
    {
        return $this->hasMany(QrUseList::class, 'qruse_user_id');
    }
}
```

#### UserRegistration
```php
class UserRegistration extends Model
{
    protected $fillable = [
        'reg_phone', 'reg_name', 'reg_email',
        'reg_password', 'reg_is_verified',
        'reg_verification_code', 'reg_expires_at'
    ];

    protected $casts = [
        'reg_is_verified' => 'boolean',
        'reg_expires_at' => 'datetime'
    ];
}
```

## ユーザー登録フロー

### 1. 登録手順
1. **基本情報入力**
   - 電話番号、名前、メールアドレス、パスワードを入力
   - システムで入力値の検証

2. **認証コード送信**
   - メールアドレスに認証コードを送信
   - 認証コードの有効期限設定

3. **認証コード確認**
   - 受信した認証コードを入力
   - システムで認証コードを検証

4. **アカウント作成**
   - 認証成功後、ユーザーアカウントを作成
   - ログイン可能な状態に設定

### 2. バリデーション
```php
// ユーザー登録時のバリデーション
$request->validate([
    'reg_phone' => 'required|string|unique:users,user_phone',
    'reg_name' => 'required|string|max:255',
    'reg_email' => 'required|email|unique:users,user_email',
    'reg_password' => 'required|string|min:8|confirmed'
]);
```

## ブラックリスト機能

### 1. ブラックリスト管理
- **有効/無効切り替え**: ユーザーのブラックリスト状態を切り替え
- **理由記録**: ブラックリスト登録理由の記録
- **自動制限**: ブラックリストユーザーの自動アクセス制限

### 2. 実装
```php
// ブラックリスト切り替え
public function toggleBlacklist($id)
{
    $user = User::findOrFail($id);
    $user->user_is_blacklisted = !$user->user_is_blacklisted;
    $user->save();

    $status = $user->user_is_blacklisted ? 'ブラックリストに追加' : 'ブラックリストから削除';
    return redirect()->route('admin.users')->with('success', "ユーザーを{$status}しました。");
}
```

## 統計機能

### 1. ユーザー統計
- **総ユーザー数**: 登録済みユーザーの総数
- **アクティブユーザー**: アクティブなユーザー数
- **非アクティブユーザー**: 非アクティブなユーザー数
- **ブラックリストユーザー**: ブラックリスト登録ユーザー数

### 2. 実装
```php
// ユーザー統計の取得
$stats = [
    'total_users' => User::count(),
    'active_users' => User::where('user_is_active', true)->count(),
    'inactive_users' => User::where('user_is_active', false)->count(),
    'blacklisted_users' => User::where('user_is_blacklisted', true)->count(),
];
```

## セキュリティ機能

### 1. パスワード管理
- **ハッシュ化**: Laravel標準のパスワードハッシュ化
- **強度チェック**: パスワード強度の検証
- **変更履歴**: パスワード変更履歴の記録

### 2. メール認証
- **認証コード**: 6桁の認証コード生成
- **有効期限**: 認証コードの有効期限管理
- **再送機能**: 認証コードの再送機能

### 3. アクセス制御
- **ブラックリスト**: ブラックリストユーザーのアクセス制限
- **アカウント停止**: 非アクティブユーザーのアクセス制限
- **ログイン制限**: 不正ログイン試行の制限

## フロントエンド機能

### 1. ユーザー一覧画面
```html
<!-- 統計情報 -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="info-box">
            <span class="info-box-icon bg-info">
                <i class="fas fa-users"></i>
            </span>
            <div class="info-box-content">
                <span class="info-box-text">総ユーザー数</span>
                <span class="info-box-number">{{ $stats['total_users'] }}</span>
            </div>
        </div>
    </div>
    <!-- 他の統計ボックス -->
</div>

<!-- ユーザー一覧テーブル -->
<table class="table table-bordered table-striped">
    <thead>
        <tr>
            <th>ID</th>
            <th>電話番号</th>
            <th>名前</th>
            <th>メールアドレス</th>
            <th>登録日</th>
            <th>状態</th>
            <th>操作</th>
        </tr>
    </thead>
    <tbody>
        @foreach($users as $user)
        <tr>
            <td>{{ $user->id }}</td>
            <td>{{ $user->user_phone }}</td>
            <td>{{ $user->user_name }}</td>
            <td>{{ $user->user_email }}</td>
            <td>{{ $user->user_created_at->format('Y年m月d日 H:i') }}</td>
            <td>
                @if($user->user_is_active)
                    <span class="badge badge-success">アクティブ</span>
                @else
                    <span class="badge badge-warning">非アクティブ</span>
                @endif
                @if($user->user_is_blacklisted)
                    <span class="badge badge-danger ml-1">ブラックリスト</span>
                @endif
            </td>
            <td>
                <div class="btn-group" role="group">
                    <a href="{{ route('admin.users.show', $user->id) }}" 
                       class="btn btn-sm btn-primary">
                        <i class="fas fa-eye"></i> 詳細
                    </a>
                    <button type="button" 
                            class="btn btn-sm btn-warning"
                            onclick="toggleBlacklist({{ $user->id }})">
                        <i class="fas fa-ban"></i> BKL
                    </button>
                    <button type="button" 
                            class="btn btn-sm btn-danger"
                            onclick="deleteUser({{ $user->id }})">
                        <i class="fas fa-trash"></i> 削除
                    </button>
                </div>
            </td>
        </tr>
        @endforeach
    </tbody>
</table>
```

### 2. JavaScript機能
```javascript
// ブラックリスト切り替え
function toggleBlacklist(userId) {
    if (confirm('ブラックリスト状態を切り替えますか？')) {
        fetch(`/admin/users/${userId}/toggle-blacklist`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('エラーが発生しました。');
            }
        });
    }
}

// ユーザー削除
function deleteUser(userId) {
    if (confirm('このユーザーを削除しますか？\n\nこの操作は取り消せません。')) {
        fetch(`/admin/users/${userId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('エラーが発生しました。');
            }
        });
    }
}
```

## エラーハンドリング

### 1. バリデーションエラー
- **重複チェック**: 電話番号・メールアドレスの重複検証
- **形式チェック**: メールアドレス形式の検証
- **必須項目**: 必須項目の入力チェック

### 2. システムエラー
- **データベースエラー**: データベース操作エラーの処理
- **メール送信エラー**: 認証コード送信エラーの処理
- **ファイル操作エラー**: ファイルアップロードエラーの処理

## ログ機能

### 1. ユーザー操作ログ
```php
// ユーザー登録
\Log::info('User registration', [
    'phone' => $request->reg_phone,
    'email' => $request->reg_email,
    'ip' => $request->ip()
]);

// ブラックリスト操作
\Log::info('User blacklist toggle', [
    'user_id' => $user->id,
    'action' => $user->user_is_blacklisted ? 'added' : 'removed',
    'admin_id' => Auth::guard('admin')->id()
]);

// ユーザー削除
\Log::warning('User deleted', [
    'user_id' => $user->id,
    'admin_id' => Auth::guard('admin')->id()
]);
```

## テスト機能

### 1. ユーザー登録テスト
```php
public function test_user_registration()
{
    $response = $this->post('/api/registrations', [
        'reg_phone' => '09012345678',
        'reg_name' => 'テストユーザー',
        'reg_email' => 'test@example.com',
        'reg_password' => 'password123',
        'reg_password_confirmation' => 'password123'
    ]);
    
    $response->assertStatus(200);
    $this->assertDatabaseHas('user_registrations', [
        'reg_phone' => '09012345678',
        'reg_email' => 'test@example.com'
    ]);
}
```

## 運用・保守

### 1. 定期メンテナンス
- **古い登録データ**: 期限切れ登録データの削除
- **ログローテーション**: ユーザー操作ログの定期整理
- **統計更新**: ユーザー統計の定期更新

### 2. セキュリティ監視
- **不正アクセス**: 不正なユーザー登録の検知
- **スパム対策**: 大量登録の検知・制限
- **アカウント保護**: アカウント乗っ取りの検知

---

**作成日**: 2025年8月25日  
**バージョン**: 1.0  
**作成者**: AI Assistant
