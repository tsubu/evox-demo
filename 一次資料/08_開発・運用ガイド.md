# 開発・運用ガイド

## 概要
EvoXシステムの開発・運用に関する包括的なガイドです。開発環境のセットアップから本番運用まで、必要な手順と注意事項を説明します。

## 開発環境セットアップ

### 1. 必要なソフトウェア

#### 必須ソフトウェア
- **PHP 8.1以上**
- **Composer 2.0以上**
- **Node.js 16以上**
- **npm 8以上**
- **PostgreSQL 13以上**
- **Git**

#### 推奨ソフトウェア
- **MAMP**（ローカル開発用）
- **Visual Studio Code**
- **Postman**（APIテスト用）

### 2. 環境構築手順

#### バックエンド環境構築
```bash
# 1. プロジェクトクローン
git clone <repository-url>
cd evox/backend

# 2. 依存関係インストール
composer install

# 3. 環境設定ファイル作成
cp .env.example .env

# 4. アプリケーションキー生成
php artisan key:generate

# 5. データベース設定
# .envファイルでデータベース接続情報を設定

# 6. マイグレーション実行
php artisan migrate

# 7. シーダー実行
php artisan db:seed

# 8. 開発サーバー起動
php artisan serve --host=0.0.0.0 --port=8000
```

#### フロントエンド環境構築
```bash
# 1. フロントエンドディレクトリ移動
cd ../frontend

# 2. 依存関係インストール
npm install

# 3. 開発サーバー起動
npm run dev
```

### 3. 環境設定ファイル

#### .env設定例
```env
# アプリケーション設定
APP_NAME=EvoX
APP_ENV=local
APP_KEY=base64:your-app-key
APP_DEBUG=true
APP_URL=http://localhost:8000

# データベース設定
DB_CONNECTION=pgsql
DB_HOST=127.0.0.1
DB_PORT=5432
DB_DATABASE=evox
DB_USERNAME=your_username
DB_PASSWORD=your_password

# 管理者認証設定
ADMIN_URL_HASH=evox2025

# SMS設定
SMS_SERVICE=twilio
TWILIO_ACCOUNT_SID=your_account_sid
TWILIO_AUTH_TOKEN=your_auth_token
TWILIO_PHONE_NUMBER=your_phone_number

# ログ設定
LOG_CHANNEL=stack
LOG_DEPRECATIONS_CHANNEL=null
LOG_LEVEL=debug
```

## 開発ガイドライン

### 1. コーディング規約

#### PHP（Laravel）
- **PSR-12**: PSR-12コーディング規約に準拠
- **命名規則**: 
  - クラス名: PascalCase
  - メソッド名: camelCase
  - 変数名: camelCase
  - 定数名: UPPER_SNAKE_CASE
- **コメント**: PHPDoc形式でコメント記述
- **インデント**: 4スペース

#### JavaScript
- **ES6+**: モダンJavaScript（ES6以上）を使用
- **命名規則**:
  - 変数・関数名: camelCase
  - 定数名: UPPER_SNAKE_CASE
  - クラス名: PascalCase
- **コメント**: JSDoc形式でコメント記述
- **インデント**: 2スペース

### 2. データベース設計規約

#### テーブル命名
- **プレフィックス**: 機能別プレフィックス（user_, qr_, game_）
- **スネークケース**: テーブル名・カラム名はスネークケース
- **複数形**: テーブル名は複数形

#### カラム命名
- **機能プレフィックス**: テーブル名のプレフィックスをカラム名にも使用
- **型サフィックス**: 必要に応じて型を示すサフィックス（_at, _id, _count）

### 3. API設計規約

#### RESTful API
- **HTTPメソッド**: GET, POST, PUT, DELETEを適切に使用
- **URL設計**: リソース指向のURL設計
- **レスポンス形式**: 統一されたJSONレスポンス形式

#### レスポンス形式
```json
{
    "success": true,
    "message": "操作が完了しました。",
    "data": {
        // データ
    },
    "errors": null
}
```

### 4. セキュリティガイドライン

#### 認証・認可
- **セッション管理**: 適切なセッション管理
- **CSRF保護**: 全フォームでCSRFトークン使用
- **XSS対策**: 入力値の適切なエスケープ
- **SQLインジェクション対策**: Eloquent ORM使用

#### データ保護
- **個人情報**: 個人情報の適切な取り扱い
- **パスワード**: ハッシュ化による安全な保存
- **ログ管理**: 機密情報のログ出力回避

## テストガイドライン

### 1. テスト種類

#### 単体テスト
- **PHPUnit**: Laravel標準のPHPUnitを使用
- **テスト対象**: モデル、サービス、ヘルパー関数
- **カバレッジ**: 80%以上のカバレッジを目標

#### 機能テスト
- **テスト対象**: コントローラー、APIエンドポイント
- **テスト内容**: 正常系・異常系の動作確認
- **データベース**: テスト用データベースを使用

#### 統合テスト
- **テスト対象**: システム全体の動作
- **テスト内容**: エンドツーエンドの動作確認
- **ブラウザテスト**: Selenium等を使用

### 2. テスト実行

#### テスト実行コマンド
```bash
# 全テスト実行
php artisan test

# 特定のテスト実行
php artisan test --filter=UserTest

# カバレッジレポート生成
php artisan test --coverage
```

### 3. テストデータ

#### ファクトリー
```php
// ユーザーファクトリー例
class UserFactory extends Factory
{
    public function definition()
    {
        return [
            'user_phone' => $this->faker->phoneNumber(),
            'user_name' => $this->faker->name(),
            'user_email' => $this->faker->unique()->safeEmail(),
            'user_password' => Hash::make('password'),
            'user_is_active' => true,
        ];
    }
}
```

## デプロイメントガイド

### 1. 本番環境準備

#### サーバー要件
- **OS**: Ubuntu 20.04 LTS以上
- **PHP**: 8.1以上
- **PostgreSQL**: 13以上
- **Nginx**: 1.18以上
- **SSL証明書**: Let's Encrypt等

#### サーバー設定
```bash
# 1. システムアップデート
sudo apt update && sudo apt upgrade -y

# 2. 必要なパッケージインストール
sudo apt install nginx postgresql php8.3-fpm php8.3-pgsql composer git

# 3. PostgreSQL設定
sudo -u postgres createuser evox_user
sudo -u postgres createdb evox_db
sudo -u postgres psql -c "ALTER USER evox_user WITH PASSWORD 'secure_password';"

# 4. Nginx設定
sudo nano /etc/nginx/sites-available/evox
```

### 2. デプロイメント手順

#### 自動デプロイメント
```bash
# 1. コードデプロイ
git pull origin main

# 2. 依存関係インストール
composer install --no-dev --optimize-autoloader
npm install --production

# 3. アセットビルド
npm run build

# 4. マイグレーション実行
php artisan migrate --force

# 5. キャッシュクリア
php artisan config:cache
php artisan route:cache
php artisan view:cache

# 6. 権限設定
chmod -R 755 storage bootstrap/cache
chown -R www-data:www-data storage bootstrap/cache
```

#### 手動デプロイメント
```bash
# 1. バックアップ作成
pg_dump evox_db > backup_$(date +%Y%m%d_%H%M%S).sql

# 2. メンテナンスモード有効化
php artisan down

# 3. コード更新
git pull origin main

# 4. 依存関係更新
composer install --no-dev --optimize-autoloader

# 5. マイグレーション実行
php artisan migrate --force

# 6. キャッシュ更新
php artisan config:cache
php artisan route:cache
php artisan view:cache

# 7. メンテナンスモード無効化
php artisan up
```

### 3. 環境設定

#### 本番環境設定
```env
# アプリケーション設定
APP_NAME=EvoX
APP_ENV=production
APP_DEBUG=false
APP_URL=https://your-domain.com

# データベース設定
DB_CONNECTION=pgsql
DB_HOST=localhost
DB_PORT=5432
DB_DATABASE=evox_db
DB_USERNAME=evox_user
DB_PASSWORD=secure_password

# ログ設定
LOG_CHANNEL=stack
LOG_LEVEL=error

# セッション設定
SESSION_DRIVER=file
SESSION_LIFETIME=120
```

## 運用・保守ガイド

### 1. 監視項目

#### システム監視
- **サーバーリソース**: CPU、メモリ、ディスク使用率
- **アプリケーション**: レスポンス時間、エラー率
- **データベース**: 接続数、クエリ実行時間
- **ログ**: エラーログ、アクセスログ

#### 監視ツール
- **サーバー監視**: Nagios、Zabbix
- **アプリケーション監視**: New Relic、Datadog
- **ログ監視**: ELK Stack（Elasticsearch、Logstash、Kibana）

### 2. バックアップ戦略

#### データベースバックアップ
```