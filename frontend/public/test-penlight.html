<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒšãƒ³ãƒ©ã‚¤ãƒˆAPIãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #000;
            color: #fff;
            padding: 20px;
        }
        .test-area {
            background: #333;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .penlight-effect {
            width: 100%;
            height: 200px;
            border: 2px solid #666;
            border-radius: 10px;
            margin: 20px 0;
            transition: all 0.3s;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .status {
            background: #444;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .error {
            background: #dc3545;
            color: white;
            padding: 10px;
            border-radius: 5px;
        }
        .success {
            background: #28a745;
            color: white;
            padding: 10px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <h1>ãƒšãƒ³ãƒ©ã‚¤ãƒˆAPIãƒ†ã‚¹ãƒˆ</h1>
    
    <div class="test-area">
        <h2>APIãƒ†ã‚¹ãƒˆ</h2>
        <button onclick="testAPI()">APIã‚’ãƒ†ã‚¹ãƒˆ</button>
        <button onclick="startPolling()">ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹</button>
        <button onclick="stopPolling()">ãƒãƒ¼ãƒªãƒ³ã‚°åœæ­¢</button>
        <div id="api-result" class="status">çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>
    </div>
    
    <div class="test-area">
        <h2>ãƒšãƒ³ãƒ©ã‚¤ãƒˆã‚¨ãƒ•ã‚§ã‚¯ãƒˆ</h2>
        <div id="penlightEffect" class="penlight-effect"></div>
        <div id="effect-status" class="status">ã‚¨ãƒ•ã‚§ã‚¯ãƒˆçŠ¶æ…‹: éã‚¢ã‚¯ãƒ†ã‚£ãƒ–</div>
    </div>
    
    <script>
        let pollingInterval = null;
        
        async function testAPI() {
            const resultDiv = document.getElementById('api-result');
            resultDiv.innerHTML = 'APIã‚’ãƒ†ã‚¹ãƒˆä¸­...';
            
            try {
                const response = await fetch('/api/penlight/streaming-status');
                const result = await response.json();
                
                console.log('APIãƒ¬ã‚¹ãƒãƒ³ã‚¹:', result);
                
                if (result.success) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <strong>APIæˆåŠŸ</strong><br>
                            é…ä¿¡çŠ¶æ³: ${result.data.is_streaming ? 'é…ä¿¡ä¸­' : 'åœæ­¢ä¸­'}<br>
                            ãƒ—ãƒªã‚»ãƒƒãƒˆ: ${result.data.preset ? result.data.preset.name : 'ãªã—'}<br>
                            ãƒ‘ã‚¿ãƒ¼ãƒ³: ${result.data.preset ? result.data.preset.pattern : 'ãªã—'}<br>
                            BPM: ${result.data.preset ? result.data.preset.bpm : 'ãªã—'}
                        </div>
                    `;
                    
                    if (result.data.is_streaming && result.data.preset) {
                        updatePenlightEffect(result.data.preset);
                    }
                } else {
                    resultDiv.innerHTML = `<div class="error">APIã‚¨ãƒ©ãƒ¼: ${result.message}</div>`;
                }
            } catch (error) {
                console.error('APIã‚¨ãƒ©ãƒ¼:', error);
                resultDiv.innerHTML = `<div class="error">APIã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
            }
        }
        
        function updatePenlightEffect(preset) {
            const effect = document.getElementById('penlightEffect');
            const status = document.getElementById('effect-status');
            
            const pattern = preset.pattern || 'solid';
            const bpm = preset.bpm || 120;
            const brightness = preset.brightness || 80;
            const penlightColor = preset.penlight_color || '#ff0000';
            const songColor = preset.color || '#ff0000';
            const audioSync = preset.audio_sync || false;
            const musicIntensity = preset.music_intensity || 0.8;
            
            console.log('ğŸ¨ ã‚¨ãƒ•ã‚§ã‚¯ãƒˆæ›´æ–°:', { pattern, bpm, brightness, audioSync, musicIntensity });
            
            // ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³èƒŒæ™¯ã‚’ä½œæˆ
            const gradient = `linear-gradient(45deg, ${songColor} 0%, ${penlightColor} 50%, ${songColor} 100%)`;
            effect.style.background = gradient;
            effect.style.backgroundSize = '400% 400%';
            
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¨­å®š
            if (pattern && pattern !== 'solid') {
                const duration = 60 / bpm;
                
                if (audioSync) {
                    // éŸ³å£°é€£å‹•ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆ
                    effect.style.animation = `${pattern} ${duration}s infinite paused`;
                    effect.style.opacity = '0.3';
                    console.log('ğŸ¤ éŸ³å£°é€£å‹•ãƒ¢ãƒ¼ãƒ‰: ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä¸€æ™‚åœæ­¢');
                } else {
                    // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆ
                    effect.style.animation = `${pattern} ${duration}s infinite`;
                    effect.style.opacity = (brightness / 100).toString();
                }
            } else {
                effect.style.animation = 'none';
                effect.style.opacity = (brightness / 100).toString();
            }
            
            // æ˜åº¦ã‚’è¨­å®šï¼ˆéŸ³å£°é€£å‹•ãƒ¢ãƒ¼ãƒ‰ã§ãªã„å ´åˆã®ã¿ï¼‰
            if (!audioSync) {
                effect.style.filter = `brightness(${brightness / 50})`;
            }
            
            status.innerHTML = `
                ã‚¨ãƒ•ã‚§ã‚¯ãƒˆçŠ¶æ…‹: ã‚¢ã‚¯ãƒ†ã‚£ãƒ–<br>
                ãƒ—ãƒªã‚»ãƒƒãƒˆ: ${preset.name}<br>
                ãƒ‘ã‚¿ãƒ¼ãƒ³: ${pattern}<br>
                BPM: ${bpm}<br>
                æ˜åº¦: ${brightness}%<br>
                éŸ³å£°é€£å‹•: ${audioSync ? 'ON' : 'OFF'}<br>
                éŸ³æ¥½æ„Ÿåº¦: ${musicIntensity}
            `;
        }
        
        function startPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }
            
            pollingInterval = setInterval(() => {
                testAPI();
            }, 2000);
            
            console.log('ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹');
        }
        
        function stopPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }
            
            console.log('ãƒãƒ¼ãƒªãƒ³ã‚°åœæ­¢');
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆå›ãƒ†ã‚¹ãƒˆ
        window.addEventListener('load', () => {
            console.log('ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');
            testAPI();
        });
    </script>
    
    <style>
        @keyframes pulse {
            0%, 100% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(1.1); filter: brightness(1.3); }
        }
        
        @keyframes blink {
            0%, 20% { opacity: 1; transform: scale(1); filter: brightness(1.5); }
            21%, 40% { opacity: 0.3; transform: scale(0.8); filter: brightness(0.8); }
            41%, 60% { opacity: 1; transform: scale(1.2); filter: brightness(2); }
            61%, 80% { opacity: 0.4; transform: scale(0.9); filter: brightness(0.9); }
            81%, 100% { opacity: 1; transform: scale(1); filter: brightness(1.5); }
        }
        
        @keyframes fade {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }
        
        @keyframes wave {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        @keyframes strobe {
            0%, 10% { opacity: 1; filter: brightness(2); }
            11%, 20% { opacity: 0.1; filter: brightness(0.5); }
            21%, 30% { opacity: 1; filter: brightness(2); }
            31%, 40% { opacity: 0.1; filter: brightness(0.5); }
            41%, 50% { opacity: 1; filter: brightness(2); }
            51%, 60% { opacity: 0.1; filter: brightness(0.5); }
            61%, 70% { opacity: 1; filter: brightness(2); }
            71%, 80% { opacity: 0.1; filter: brightness(0.5); }
            81%, 90% { opacity: 1; filter: brightness(2); }
            91%, 100% { opacity: 0.1; filter: brightness(0.5); }
        }
    </style>
</body>
</html>
